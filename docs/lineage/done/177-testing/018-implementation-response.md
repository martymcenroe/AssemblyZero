Now I understand the codebase. The `agentos/utils/lld_verification.py` module already exists with the implementation. The tests file needs to be updated to actually use the module. Let me now create the updated test file and a separate test file in `tests/test_lld_verification.py`:

```python
# File: tests/test_issue_177.py

"""Test file for Issue #177.

Generated by AgentOS TDD Testing Workflow.
Tests LLD approval verification gate functionality.
"""

import pytest
from pathlib import Path
import tempfile
import os

from agentos.utils.lld_verification import (
    LLDVerificationResult,
    LLDVerificationError,
    has_gemini_approved_footer,
    extract_review_log_verdicts,
    detect_false_approval,
    verify_lld_approval,
    validate_lld_path,
    run_verification_gate,
)


# Test LLD content fixtures
@pytest.fixture
def lld_with_gemini_footer():
    """LLD with genuine Gemini APPROVED footer."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-15 | APPROVED | None |

**Final Status:** APPROVED

<sub>**Gemini Review:** APPROVED | **Model:** gemini-3-pro-preview | **Date:** 2026-01-15</sub>
"""


@pytest.fixture
def lld_with_review_log_approval():
    """LLD with review log final APPROVED verdict (no footer)."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-10 | REVISE | Missing section |
| 2 | 2026-01-12 | REVISE | Needs clarification |
| 3 | 2026-01-15 | APPROVED | None |

**Final Status:** APPROVED
"""


@pytest.fixture
def lld_false_approval_revise():
    """LLD with REVISE verdict but APPROVED status (forgery)."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-15 | REVISE | Needs work |

**Final Status:** APPROVED
"""


@pytest.fixture
def lld_false_approval_pending():
    """LLD with PENDING verdict but APPROVED status (forgery)."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-15 | PENDING | Awaiting review |

**Final Status:** APPROVED
"""


@pytest.fixture
def lld_no_approval():
    """LLD with no approval markers."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

## 2. Proposed Changes

Some changes here.
"""


@pytest.fixture
def lld_multiple_reviews_approved_last():
    """LLD with multiple reviews, last is APPROVED."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-10 | REVISE | Missing context |
| 2 | 2026-01-12 | REVISE | Still incomplete |
| 3 | 2026-01-15 | APPROVED | All issues resolved |

**Final Status:** APPROVED
"""


@pytest.fixture
def lld_multiple_reviews_revise_last():
    """LLD with multiple reviews, last is REVISE."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-10 | APPROVED | Looked good initially |
| 2 | 2026-01-15 | REVISE | Found new issues |

**Final Status:** PENDING
"""


@pytest.fixture
def lld_empty_review_log():
    """LLD with empty review log section."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|

## 2. Proposed Changes

Some changes here.
"""


@pytest.fixture
def lld_approved_no_final_status():
    """LLD with approved content but no Final Status line."""
    return """# LLD-177 - Test Feature

## 1. Context & Goal

This is a test LLD.

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|

## 2. Proposed Changes

Some changes here.
"""


# Integration/E2E fixtures
@pytest.fixture
def temp_project_dir():
    """Temporary project directory for integration tests."""
    with tempfile.TemporaryDirectory() as tmpdir:
        yield Path(tmpdir)


@pytest.fixture
def valid_lld_file(temp_project_dir, lld_with_gemini_footer):
    """Create a valid LLD file in temp directory."""
    lld_path = temp_project_dir / "docs" / "LLDs" / "active" / "177-test.md"
    lld_path.parent.mkdir(parents=True, exist_ok=True)
    lld_path.write_text(lld_with_gemini_footer)
    return lld_path


@pytest.fixture
def invalid_lld_file(temp_project_dir, lld_no_approval):
    """Create an invalid LLD file (not approved) in temp directory."""
    lld_path = temp_project_dir / "docs" / "LLDs" / "active" / "177-invalid.md"
    lld_path.parent.mkdir(parents=True, exist_ok=True)
    lld_path.write_text(lld_no_approval)
    return lld_path


# Unit Tests
# -----------

def test_010(lld_with_gemini_footer):
    """
    Genuine footer approval | Auto | LLD with `<sub>**Gemini Review:**
    APPROVED...` | is_valid=True, confidence="high" | Returns pass
    """
    # TDD: Act
    result = verify_lld_approval(lld_with_gemini_footer)

    # TDD: Assert
    assert result["is_valid"] is True
    assert result["confidence"] == "high"
    assert result["approval_source"] == "footer"
    assert result["error_type"] is None


def test_020(lld_with_review_log_approval):
    """
    Review log approval (final) | Auto | LLD with `\ | APPROVED \ | ` as
    last row | is_valid=True, confidence="medium" | Returns pass
    """
    # TDD: Act
    result = verify_lld_approval(lld_with_review_log_approval)

    # TDD: Assert
    assert result["is_valid"] is True
    assert result["confidence"] == "medium"
    assert result["approval_source"] == "review_log"
    assert result["error_type"] is None


def test_030(lld_false_approval_revise):
    """
    False approval - REVISE then APPROVED status | Auto | Review shows
    REVISE, status APPROVED | is_valid=False, error_type="forgery" |
    Returns fail with "FALSE APPROVAL"
    """
    # TDD: Act
    result = verify_lld_approval(lld_false_approval_revise)

    # TDD: Assert
    assert result["is_valid"] is False
    assert result["error_type"] == "forgery"
    assert "FALSE APPROVAL" in result["reason"]


def test_040(lld_false_approval_pending):
    """
    False approval - PENDING then APPROVED status | Auto | Review shows
    PENDING, status APPROVED | is_valid=False, error_type="forgery" |
    Returns fail with "FALSE APPROVAL"
    """
    # TDD: Act
    result = verify_lld_approval(lld_false_approval_pending)

    # TDD: Assert
    assert result["is_valid"] is False
    assert result["error_type"] == "forgery"
    assert "FALSE APPROVAL" in result["reason"]


def test_050(lld_no_approval):
    """
    No approval evidence | Auto | LLD with no approval markers |
    is_valid=False, error_type="not_approved" | Returns fail
    """
    # TDD: Act
    result = verify_lld_approval(lld_no_approval)

    # TDD: Assert
    assert result["is_valid"] is False
    assert result["error_type"] == "not_approved"


def test_060(lld_multiple_reviews_approved_last):
    """
    Multiple reviews, last is APPROVED | Auto | 3 reviews: REVISE,
    REVISE, APPROVED | is_valid=True | Returns pass
    """
    # TDD: Act
    result = verify_lld_approval(lld_multiple_reviews_approved_last)

    # TDD: Assert
    assert result["is_valid"] is True
    assert result["last_verdict"] == "APPROVED"


def test_070(lld_multiple_reviews_revise_last):
    """
    Multiple reviews, last is REVISE | Auto | 3 reviews: APPROVED, REVISE
    | is_valid=False | Returns fail
    """
    # TDD: Act
    result = verify_lld_approval(lld_multiple_reviews_revise_last)

    # TDD: Assert
    assert result["is_valid"] is False
    assert result["last_verdict"] == "REVISE"


def test_080(lld_empty_review_log):
    """
    Empty review log | Auto | Review log section exists but empty |
    is_valid=False, error_type="not_approved" | Returns fail
    """
    # TDD: Act
    result = verify_lld_approval(lld_empty_review_log)

    # TDD: Assert
    assert result["is_valid"] is False
    assert result["error_type"] == "not_approved"


def test_110(temp_project_dir):
    """
    Path traversal attempt | Auto | Path outside project root | Raises
    exception before read | Security check blocks
    """
    # TDD: Arrange
    outside_path = Path("/etc/passwd")  # Path outside project

    # TDD: Act & Assert
    with pytest.raises(LLDVerificationError) as exc_info:
        validate_lld_path(outside_path, temp_project_dir)

    assert exc_info.value.error_type == "security"
    assert "traversal" in exc_info.value.reason.lower() or "outside" in exc_info.value.reason.lower()


def test_120(lld_approved_no_final_status):
    """
    Status APPROVED but no Final Status line | Auto | LLD missing Final
    Status section | is_valid=False, error_type="not_approved" | Returns
    fail
    """
    # TDD: Act
    result = verify_lld_approval(lld_approved_no_final_status)

    # TDD: Assert
    assert result["is_valid"] is False
    assert result["error_type"] == "not_approved"


# Integration Tests
# -----------------

def test_090(valid_lld_file, temp_project_dir):
    """
    Gate integration - pass | Auto | Valid LLD path | No exception raised
    | Workflow continues
    """
    # TDD: Act - should not raise
    result = run_verification_gate(valid_lld_file, temp_project_dir)

    # TDD: Assert
    assert result["is_valid"] is True
    assert result["confidence"] == "high"


def test_100(invalid_lld_file, temp_project_dir):
    """
    Gate integration - fail | Auto | Invalid LLD path |
    LLDVerificationError raised | Exception has suggestion
    """
    # TDD: Act & Assert
    with pytest.raises(LLDVerificationError) as exc_info:
        run_verification_gate(invalid_lld_file, temp_project_dir)

    assert exc_info.value.suggestion is not None
    assert len(exc_info.value.suggestion) > 0
```

```python
# File: tests/test_lld_verification.py

"""Unit tests for LLD verification module.

This file provides comprehensive unit tests for the lld_verification module,
following the test matrix from Issue #177 LLD.
"""

import pytest
from pathlib import Path
import tempfile

from agentos.utils.lld_verification import (
    LLDVerificationResult,
    LLDVerificationError,
    has_gemini_approved_footer,
    extract_review_log_verdicts,
    detect_false_approval,
    verify_lld_approval,
    validate_lld_path,
    run_verification_gate,
    _get_suggestion_for_error_type,
)


class TestHasGeminiApprovedFooter:
    """Tests for has_gemini_approved_footer function."""

    def test_detects_standard_footer(self):
        """Detects standard Gemini APPROVED footer."""
        content = '<sub>**Gemini Review:** APPROVED | **Model:** gemini-3-pro</sub>'
        assert has_gemini_approved_footer(content) is True

    def test_detects_footer_with_whitespace(self):
        """Detects footer with extra whitespace."""
        content = '<sub>  **Gemini  Review:**  APPROVED | **Model:** gemini-3-pro</sub>'
        assert has_gemini_approved_footer(content) is True

    def test_case_insensitive_approved(self):
        """APPROVED is detected case-insensitively."""
        content = '<sub>**Gemini Review:** approved | **Model:** gemini-3-pro</sub>'
        assert has_gemini_approved_footer(content) is True

    def test_no_footer_returns_false(self):
        """Returns False when no footer present."""
        content = '# Just a regular document\n\nNo footer here.'
        assert has_gemini_approved_footer(content) is False

    def test_revise_footer_returns_false(self):
        """REVISE footer should not match."""
        content = '<sub>**Gemini Review:** REVISE | **Model:** gemini-3-pro</sub>'
        assert has_gemini_approved_footer(content) is False


class TestExtractReviewLogVerdicts:
    """Tests for extract_review_log_verdicts function."""

    def test_extracts_single_verdict(self):
        """Extracts single review verdict from table."""
        content = """### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-15 | APPROVED | None |
"""
        verdicts = extract_review_log_verdicts(content)
        assert len(verdicts) == 1
        assert verdicts[0][2] == "APPROVED"

    def test_extracts_multiple_verdicts(self):
        """Extracts multiple review verdicts in order."""
        content = """### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-10 | REVISE | Missing section |
| 2 | 2026-01-12 | REVISE | Needs work |
| 3 | 2026-01-15 | APPROVED | All good |
"""
        verdicts = extract_review_log_verdicts(content)
        assert len(verdicts) == 3
        assert verdicts[0][2] == "REVISE"
        assert verdicts[1][2] == "REVISE"
        assert verdicts[2][2] == "APPROVED"

    def test_handles_no_review_section(self):
        """Returns empty list when no Review Summary section."""
        content = "# Just a document\n\nNo review section here."
        verdicts = extract_review_log_verdicts(content)
        assert verdicts == []

    def test_handles_empty_table(self):
        """Returns empty list for empty review table."""
        content = """### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|

## Next Section
"""
        verdicts = extract_review_log_verdicts(content)
        assert verdicts == []

    def test_normalizes_pending_verdict(self):
        """Normalizes PENDING and AWAITING to PENDING."""
        content = """### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-15 | Awaiting review | - |
"""
        verdicts = extract_review_log_verdicts(content)
        assert len(verdicts) == 1
        assert verdicts[0][2] == "PENDING"


class TestDetectFalseApproval:
    """Tests for detect_false_approval function."""

    def test_no_false_when_matching(self):
        """No false approval when status matches verdict."""
        content = "**Final Status:** APPROVED"
        is_false, details = detect_false_approval(content, "APPROVED")
        assert is_false is False

    def test_detects_revise_vs_approved(self):
        """Detects mismatch: REVISE verdict with APPROVED status."""
        content = "**Final Status:** APPROVED"
        is_false, details = detect_false_approval(content, "REVISE")
        assert is_false is True
        assert "REVISE" in details

    def test_detects_pending_vs_approved(self):
        """Detects mismatch: PENDING verdict with APPROVED status."""
        content = "**Final Status:** APPROVED"
        is_false, details = detect_false_approval(content, "PENDING")
        assert is_false is True
        assert "PENDING" in details

    def test_no_false_without_final_status(self):
        """No false approval if Final Status line is missing."""
        content = "Some content without status"
        is_false, details = detect_false_approval(content, "REVISE")
        assert is_false is False


class TestVerifyLldApproval:
    """Tests for verify_lld_approval main function."""

    def test_high_confidence_with_footer(self):
        """Footer gives high confidence approval."""
        content = """# LLD

<sub>**Gemini Review:** APPROVED | **Model:** gemini-3-pro</sub>
"""
        result = verify_lld_approval(content)
        assert result["is_valid"] is True
        assert result["confidence"] == "high"
        assert result["approval_source"] == "footer"

    def test_medium_confidence_with_review_log(self):
        """Review log gives medium confidence approval."""
        content = """# LLD

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-15 | APPROVED | None |

**Final Status:** APPROVED
"""
        result = verify_lld_approval(content)
        assert result["is_valid"] is True
        assert result["confidence"] == "medium"
        assert result["approval_source"] == "review_log"

    def test_forgery_detection(self):
        """Detects forgery when verdicts don't match status."""
        content = """# LLD

### Review Summary

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| 1 | 2026-01-15 | REVISE | Needs work |

**Final Status:** APPROVED
"""
        result = verify_lld_approval(content)
        assert result["is_valid"] is False
        assert result["error_type"] == "forgery"
        assert "FALSE APPROVAL" in result["reason"]

    def test_not_approved_no_markers(self):
        """Returns not_approved when no approval markers."""
        content = "# Just a document without any approval"
        result = verify_lld_approval(content)
        assert result["is_valid"] is False
        assert result["error_type"] == "not_approved"


class TestValidateLldPath:
    """Tests for validate_lld_path security function."""

    def test_accepts_path_within_project(self):
        """Accepts paths within project root."""
        with tempfile.TemporaryDirectory() as tmpdir:
            project_root = Path(tmpdir)
            lld_path = project_root / "docs" / "LLDs" / "test.md"
            # Should not raise
            validate_lld_path(lld_path, project_root)

    def test_rejects_path_outside_project(self):
        """Rejects paths outside project root."""
        with tempfile.TemporaryDirectory() as tmpdir:
            project_root = Path(tmpdir)
            outside_path = Path("/etc/passwd")
            
            with pytest.raises(LLDVerificationError) as exc_info:
                validate_lld_path(outside_path, project_root)
            
            assert exc_info.value.error_type == "security"

    def test_rejects_parent_traversal(self):
        """Rejects parent directory traversal attempts."""
        with tempfile.TemporaryDirectory() as tmpdir:
            project_root = Path(tmpdir)
            traversal_path = project_root / ".." / ".." / "etc" / "passwd"
            
            with pytest.raises(LLDVerificationError) as exc_info:
                validate_lld_path(traversal_path, project_root)
            
            assert exc_info.value.error_type == "security"


class TestRunVerificationGate:
    """Tests for run_verification_gate integration function."""

    def test_passes_valid_lld(self):
        """Gate passes for valid approved LLD."""
        with tempfile.TemporaryDirectory() as tmpdir:
            project_root = Path(tmpdir)
            lld_path = project_root / "test.md"
            lld_path.write_text("""# LLD
            
<sub>**Gemini Review:** APPROVED | **Model:** gemini-3-pro</sub>
""")
            result = run_verification_gate(lld_path, project_root)
            assert result["is_valid"] is True

    def test_raises_for_unapproved_lld(self):
        """Gate raises error for unapproved LLD."""
        with tempfile.TemporaryDirectory() as tmpdir:
            project_root = Path(tmpdir)
            lld_path = project_root / "test.md"
            lld_path.write_text("# LLD without approval")
            
            with pytest.raises(LLDVerificationError) as exc_info:
                run_verification_gate(lld_path, project_root)
            
            assert exc_info.value.error_type == "not_approved"

    def test_raises_for_missing_file(self):
        """Gate raises error for missing LLD file."""
        with tempfile.TemporaryDirectory() as tmpdir:
            project_root = Path(tmpdir)
            lld_path = project_root / "nonexistent.md"
            
            with pytest.raises(LLDVerificationError) as exc_info:
                run_verification_gate(lld_path, project_root)
            
            assert exc_info.value.error_type == "not_found"

    def test_suggestion_included_in_error(self):
        """Errors include actionable suggestions."""
        with tempfile.TemporaryDirectory() as tmpdir:
            project_root = Path(tmpdir)
            lld_path = project_root / "test.md"
            lld_path.write_text("# LLD without approval")
            
            with pytest.raises(LLDVerificationError) as exc_info:
                run_verification_gate(lld_path, project_root)
            
            assert exc_info.value.suggestion is not None
            assert len(exc_info.value.suggestion) > 0


class TestGetSuggestionForErrorType:
    """Tests for _get_suggestion_for_error_type helper."""

    def test_forgery_suggestion(self):
        """Forgery error gets re-review suggestion."""
        suggestion = _get_suggestion_for_error_type("forgery")
        assert "workflow" in suggestion.lower() or "review" in suggestion.lower()

    def test_not_approved_suggestion(self):
        """Not approved error gets submission suggestion."""
        suggestion = _get_suggestion_for_error_type("not_approved")
        assert "submit" in suggestion.lower() or "review" in suggestion.lower()

    def test_unknown_type_gets_fallback(self):
        """Unknown error types get fallback suggestion."""
        suggestion = _get_suggestion_for_error_type("unknown_error")
        assert suggestion is not None
        assert len(suggestion) > 0
```
