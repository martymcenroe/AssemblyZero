# File: tests/test_issue_177.py

```python
"""Test file for Issue #177.

Generated by AgentOS TDD Testing Workflow.
Tests for LLD verification functionality.
"""

import pytest
from pathlib import Path
import tempfile

from agentos.core.lld_verification import (
    verify_lld_approval,
    verify_lld_path_security,
    verify_lld_file,
    run_verification_gate,
    LLDVerificationResult,
    LLDVerificationError,
)


# Sample LLD content fixtures
LLD_WITH_FOOTER_APPROVAL = """# LLD-177: Test Feature

## 1. Context & Goal

* **Issue:** #177
* **Status:** Approved (gemini-3-pro-preview, 2026-02-02)

## 10. Test Plan

Test scenarios here.

---

<sub>**Gemini Review:** APPROVED (gemini-3-pro-preview, 2026-02-02)</sub>
"""

LLD_WITH_REVIEW_LOG_APPROVED = """# LLD-177: Test Feature

## 1. Context & Goal

* **Issue:** #177

## Review Log

| Date | Reviewer | Verdict |
|------|----------|---------|
| 2026-02-01 | gemini-3-pro | REVISE |
| 2026-02-02 | gemini-3-pro | APPROVED |

## 10. Test Plan

Test scenarios here.

**Final Status:** APPROVED
"""

LLD_WITH_REVISE_THEN_APPROVED_STATUS = """# LLD-177: Test Feature

## 1. Context & Goal

* **Issue:** #177

## Review Log

| Date | Reviewer | Verdict |
|------|----------|---------|
| 2026-02-01 | gemini-3-pro | REVISE |

**Final Status:** APPROVED
"""

LLD_WITH_PENDING_THEN_APPROVED_STATUS = """# LLD-177: Test Feature

## 1. Context & Goal

* **Issue:** #177

## Review Log

| Date | Reviewer | Verdict |
|------|----------|---------|
| 2026-02-01 | gemini-3-pro | PENDING |

**Final Status:** APPROVED
"""

LLD_NO_APPROVAL = """# LLD-177: Test Feature

## 1. Context & Goal

* **Issue:** #177

## 10. Test Plan

Test scenarios here.
"""

LLD_MULTIPLE_REVIEWS_LAST_APPROVED = """# LLD-177: Test Feature

## Review Log

| Date | Reviewer | Verdict |
|------|----------|---------|
| 2026-01-30 | gemini-3-pro | REVISE |
| 2026-01-31 | gemini-3-pro | REVISE |
| 2026-02-01 | gemini-3-pro | APPROVED |

**Final Status:** APPROVED
"""

LLD_MULTIPLE_REVIEWS_LAST_REVISE = """# LLD-177: Test Feature

## Review Log

| Date | Reviewer | Verdict |
|------|----------|---------|
| 2026-01-30 | gemini-3-pro | APPROVED |
| 2026-01-31 | gemini-3-pro | REVISE |

**Final Status:** REVISE
"""

LLD_EMPTY_REVIEW_LOG = """# LLD-177: Test Feature

## Review Log

| Date | Reviewer | Verdict |
|------|----------|---------|

## 10. Test Plan

Test scenarios here.
"""

LLD_APPROVED_STATUS_NO_FINAL_STATUS = """# LLD-177: Test Feature

## 1. Context & Goal

* **Issue:** #177
* **Status:** Approved (gemini-3-pro-preview, 2026-02-02)

## 10. Test Plan

Test scenarios here.
"""


# Integration/E2E fixtures
@pytest.fixture
def test_client():
    """Test client for API calls."""
    yield None


@pytest.fixture
def temp_project_dir():
    """Create a temporary project directory."""
    with tempfile.TemporaryDirectory() as tmpdir:
        project_root = Path(tmpdir)
        lld_dir = project_root / "docs" / "lld" / "active"
        lld_dir.mkdir(parents=True)
        yield project_root


# Unit Tests
# -----------

def test_010():
    """
    Genuine footer approval | Auto | LLD with `<sub>**Gemini Review:**
    APPROVED...` | is_valid=True, confidence="high" | Returns pass
    """
    # TDD: Arrange
    content = LLD_WITH_FOOTER_APPROVAL

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is True
    assert result.confidence == "high"
    assert result.approval_source == "footer"
    assert result.error_type is None


def test_020():
    """
    Review log approval (final) | Auto | LLD with `| APPROVED |` as
    last row | is_valid=True, confidence="medium" | Returns pass
    """
    # TDD: Arrange
    content = LLD_WITH_REVIEW_LOG_APPROVED

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is True
    assert result.confidence == "medium"
    assert result.approval_source == "review_log"


def test_030():
    """
    False approval - REVISE then APPROVED status | Auto | Review shows
    REVISE, status APPROVED | is_valid=False, error_type="forgery" |
    Returns fail with "FALSE APPROVAL"
    """
    # TDD: Arrange
    content = LLD_WITH_REVISE_THEN_APPROVED_STATUS

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is False
    assert result.error_type == "forgery"
    assert "FALSE APPROVAL" in result.reason


def test_040():
    """
    False approval - PENDING then APPROVED status | Auto | Review shows
    PENDING, status APPROVED | is_valid=False, error_type="forgery" |
    Returns fail with "FALSE APPROVAL"
    """
    # TDD: Arrange
    content = LLD_WITH_PENDING_THEN_APPROVED_STATUS

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is False
    assert result.error_type == "forgery"
    assert "FALSE APPROVAL" in result.reason


def test_050():
    """
    No approval evidence | Auto | LLD with no approval markers |
    is_valid=False, error_type="not_approved" | Returns fail
    """
    # TDD: Arrange
    content = LLD_NO_APPROVAL

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is False
    assert result.error_type == "not_approved"


def test_060():
    """
    Multiple reviews, last is APPROVED | Auto | 3 reviews: REVISE,
    REVISE, APPROVED | is_valid=True | Returns pass
    """
    # TDD: Arrange
    content = LLD_MULTIPLE_REVIEWS_LAST_APPROVED

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is True
    assert result.approval_source == "review_log"


def test_070():
    """
    Multiple reviews, last is REVISE | Auto | 3 reviews: APPROVED, REVISE
    | is_valid=False | Returns fail
    """
    # TDD: Arrange
    content = LLD_MULTIPLE_REVIEWS_LAST_REVISE

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is False
    assert result.error_type == "not_approved"


def test_080():
    """
    Empty review log | Auto | Review log section exists but empty |
    is_valid=False, error_type="not_approved" | Returns fail
    """
    # TDD: Arrange
    content = LLD_EMPTY_REVIEW_LOG

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is False
    assert result.error_type == "not_approved"


def test_110():
    """
    Path traversal attempt | Auto | Path outside project root | Raises
    exception before read | Security check blocks
    """
    # TDD: Arrange
    project_root = Path("/home/user/projects/myproject")
    malicious_path = Path("/etc/passwd")

    # TDD: Act & Assert
    with pytest.raises(LLDVerificationError) as exc_info:
        verify_lld_path_security(malicious_path, project_root)

    assert exc_info.value.error_type == "security"
    assert "traversal" in exc_info.value.message.lower()


def test_120():
    """
    Status APPROVED but no Final Status line | Auto | LLD missing Final
    Status section | is_valid=False, error_type="not_approved" | Returns
    fail
    """
    # TDD: Arrange
    content = LLD_APPROVED_STATUS_NO_FINAL_STATUS

    # TDD: Act
    result = verify_lld_approval(content)

    # TDD: Assert
    assert result.is_valid is False
    assert result.error_type == "not_approved"


# Integration Tests
# -----------------

def test_090(test_client, temp_project_dir):
    """
    Gate integration - pass | Auto | Valid LLD path | No exception raised
    | Workflow continues
    """
    # TDD: Arrange
    lld_path = temp_project_dir / "docs" / "lld" / "active" / "LLD-177.md"
    lld_path.write_text(LLD_WITH_FOOTER_APPROVAL, encoding="utf-8")

    # TDD: Act - should not raise
    run_verification_gate(lld_path, temp_project_dir)

    # TDD: Assert - if we reach here, the gate passed
    assert True


def test_100(test_client, temp_project_dir):
    """
    Gate integration - fail | Auto | Invalid LLD path |
    LLDVerificationError raised | Exception has suggestion
    """
    # TDD: Arrange
    lld_path = temp_project_dir / "docs" / "lld" / "active" / "LLD-177.md"
    lld_path.write_text(LLD_NO_APPROVAL, encoding="utf-8")

    # TDD: Act & Assert
    with pytest.raises(LLDVerificationError) as exc_info:
        run_verification_gate(lld_path, temp_project_dir)

    assert exc_info.value.suggestion != ""
    assert "review" in exc_info.value.suggestion.lower()
```