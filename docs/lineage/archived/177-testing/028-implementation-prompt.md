# Implementation Request

## Context

You are implementing code for Issue #177 using TDD.
This is iteration 4 of the implementation.

## Requirements

The tests have been scaffolded and need implementation code to pass.

### LLD Summary

# 177 - Feature: Implementation workflow gate to verify LLD was genuinely approved

<!-- Template Metadata
Last Updated: 2026-02-02
Updated By: Issue #177 creation
Update Reason: Revision addressing Gemini Review #1 feedback
-->

## 1. Context & Goal
* **Issue:** #177
* **Objective:** Add a pre-flight verification gate to the implementation workflow that ensures LLDs were genuinely approved by Gemini review, preventing wasted effort on unreviewed designs
* **Status:** Approved (gemini-3-pro-preview, 2026-02-02)
* **Related Issues:** #176 (Bug: LLD workflow stamps APPROVED regardless of verdict)

### Open Questions

*All questions resolved per Gemini Review #1 feedback:*

- [x] ~~Should the gate also verify the approval is recent (within N days)?~~ **Decision: No recency check for MVP.** Keep implementation simple; users can always re-run review if concerned about staleness.
- [x] ~~Should there be a `--force` flag to bypass the gate for exceptional circumstances?~~ **Decision: No force flag.** Users should fix the LLD or get a new approval per the Recovery Strategy. This maintains integrity of the approval process.

## 2. Proposed Changes

*This section is the **source of truth** for implementation. Describe exactly what will be built.*

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `src/workflows/run_implement_from_lld.py` | Modify | Add verification gate in N0 (load LLD) |
| `src/utils/lld_verification.py` | Add | New module containing verification logic |
| `tests/test_lld_verification.py` | Add | Unit tests for verification logic |

### 2.2 Dependencies

```toml
# pyproject.toml additions (if any)
# No new dependencies required - uses standard library only
```

### 2.3 Data Structures

```python
# Pseudocode - NOT implementation
class LLDVerificationResult(TypedDict):
    is_valid: bool           # Whether approval is genuine
    reason: str              # Human-readable explanation
    approval_source: str | ...

### Test Scenarios

- **test_010**: Genuine footer approval | Auto | LLD with `<sub>**Gemini Review:** APPROVED...` | is_valid=True, confidence="high" | Returns pass
  - Requirement: 
  - Type: unit

- **test_020**: Review log approval (final) | Auto | LLD with `\ | APPROVED \ | ` as last row | is_valid=True, confidence="medium" | Returns pass
  - Requirement: 
  - Type: unit

- **test_030**: False approval - REVISE then APPROVED status | Auto | Review shows REVISE, status APPROVED | is_valid=False, error_type="forgery" | Returns fail with "FALSE APPROVAL"
  - Requirement: 
  - Type: unit

- **test_040**: False approval - PENDING then APPROVED status | Auto | Review shows PENDING, status APPROVED | is_valid=False, error_type="forgery" | Returns fail with "FALSE APPROVAL"
  - Requirement: 
  - Type: unit

- **test_050**: No approval evidence | Auto | LLD with no approval markers | is_valid=False, error_type="not_approved" | Returns fail
  - Requirement: 
  - Type: unit

- **test_060**: Multiple reviews, last is APPROVED | Auto | 3 reviews: REVISE, REVISE, APPROVED | is_valid=True | Returns pass
  - Requirement: 
  - Type: unit

- **test_070**: Multiple reviews, last is REVISE | Auto | 3 reviews: APPROVED, REVISE | is_valid=False | Returns fail
  - Requirement: 
  - Type: unit

- **test_080**: Empty review log | Auto | Review log section exists but empty | is_valid=False, error_type="not_approved" | Returns fail
  - Requirement: 
  - Type: unit

- **test_090**: Gate integration - pass | Auto | Valid LLD path | No exception raised | Workflow continues
  - Requirement: 
  - Type: integration

- **test_100**: Gate integration - fail | Auto | Invalid LLD path | LLDVerificationError raised | Exception has suggestion
  - Requirement: 
  - Type: integration

- **test_110**: Path traversal attempt | Auto | Path outside project root | Raises exception before read | Security check blocks
  - Requirement: 
  - Type: unit

- **test_120**: Status APPROVED but no Final Status line | Auto | LLD missing Final Status section | is_valid=False, error_type="not_approved" | Returns fail
  - Requirement: 
  - Type: unit

### Test File: C:\Users\mcwiz\Projects\AgentOS-177\tests\test_issue_177.py

```python
"""Test file for Issue #177.

Generated by AgentOS TDD Testing Workflow.
Each test starts with `assert False` - implementation will make them pass.
"""

import pytest


# Integration/E2E fixtures
@pytest.fixture
def test_client():
    """Test client for API calls."""
    # TODO: Implement test client
    yield None


# Unit Tests
# -----------

def test_010():
    """
    Genuine footer approval | Auto | LLD with `<sub>**Gemini Review:**
    APPROVED...` | is_valid=True, confidence="high" | Returns pass
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_010"


def test_020():
    """
    Review log approval (final) | Auto | LLD with `\ | APPROVED \ | ` as
    last row | is_valid=True, confidence="medium" | Returns pass
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_020"


def test_030():
    """
    False approval - REVISE then APPROVED status | Auto | Review shows
    REVISE, status APPROVED | is_valid=False, error_type="forgery" |
    Returns fail with "FALSE APPROVAL"
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_030"


def test_040():
    """
    False approval - PENDING then APPROVED status | Auto | Review shows
    PENDING, status APPROVED | is_valid=False, error_type="forgery" |
    Returns fail with "FALSE APPROVAL"
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_040"


def test_050():
    """
    No approval evidence | Auto | LLD with no approval markers |
    is_valid=False, error_type="not_approved" | Returns fail
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_050"


def test_060():
    """
    Multiple reviews, last is APPROVED | Auto | 3 reviews: REVISE,
    REVISE, APPROVED | is_valid=True | Returns pass
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_060"


def test_070():
    """
    Multiple reviews, last is REVISE | Auto | 3 reviews: APPROVED, REVISE
    | is_valid=False | Returns fail
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_070"


def test_080():
    """
    Empty review log | Auto | Review log section exists but empty |
    is_valid=False, error_type="not_approved" | Returns fail
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_080"


def test_110():
    """
    Path traversal attempt | Auto | Path outside project root | Raises
    exception before read | Security check blocks
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_110"


def test_120():
    """
    Status APPROVED but no Final Status line | Auto | LLD missing Final
    Status section | is_valid=False, error_type="not_approved" | Returns
    fail
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_120"



# Integration Tests
# -----------------

def test_090(test_client):
    """
    Gate integration - pass | Auto | Valid LLD path | No exception raised
    | Workflow continues
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_090"


def test_100(test_client):
    """
    Gate integration - fail | Auto | Invalid LLD path |
    LLDVerificationError raised | Exception has suggestion
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_100"


```

### Source Files to Modify

These are the existing files you need to modify:

#### src/utils/lld_verification.py (NEW FILE)

New module containing verification logic

#### tests/test_lld_verification.py (NEW FILE)

Unit tests for verification logic

### Previous Test Run (FAILED)

The previous implementation attempt failed. Here's the test output:

```
77.py::test_010 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_020 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_030 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_040 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_050 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_060 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_070 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_080 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_110 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_120 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_090 - AssertionError: TDD: Implementatio...
FAILED tests/test_issue_177.py::test_100 - AssertionError: TDD: Implementatio...
============================= 12 failed in 0.06s ==============================

C:\Users\mcwiz\AppData\Local\pypoetry\Cache\virtualenvs\unleashed-Zukdy2xA-py3.14\Lib\site-packages\coverage\inorout.py:497: CoverageWarning: Module agentos.core.lld_verification was never imported. (module-not-imported); see https://coverage.readthedocs.io/en/7.13.1/messages.html#warning-module-not-imported
  self.warn(f"Module {pkg} was never imported.", slug="module-not-imported")
C:\Users\mcwiz\AppData\Local\pypoetry\Cache\virtualenvs\unleashed-Zukdy2xA-py3.14\Lib\site-packages\coverage\control.py:958: CoverageWarning: No data was collected. (no-data-collected); see https://coverage.readthedocs.io/en/7.13.1/messages.html#warning-no-data-collected
  self._warn("No data was collected.", slug="no-data-collected")
C:\Users\mcwiz\AppData\Local\pypoetry\Cache\virtualenvs\unleashed-Zukdy2xA-py3.14\Lib\site-packages\pytest_cov\plugin.py:363: CovReportWarning: Failed to generate report: No data to report.

  warnings.warn(CovReportWarning(message), stacklevel=1)

```

Please fix the issues and provide updated implementation.

## Instructions

1. Generate implementation code that makes all tests pass
2. Follow the patterns established in the codebase
3. Ensure proper error handling
4. Add type hints where appropriate
5. Keep the implementation minimal - only what's needed to pass tests

## Output Format (CRITICAL - MUST FOLLOW EXACTLY)

For EACH file you need to create or modify, provide a code block with this EXACT format:

```python
# File: path/to/implementation.py

def function_name():
    ...
```

**Rules:**
- The `# File: path/to/file` comment MUST be the FIRST line inside the code block
- Use the language-appropriate code fence (```python, ```gitignore, ```yaml, etc.)
- Path must be relative to repository root (e.g., `src/module/file.py`)
- Do NOT include "(append)" or other annotations in the path
- Provide complete file contents, not patches or diffs

**Example for .gitignore:**
```gitignore
# File: .gitignore

# Existing patterns...
*.pyc
__pycache__/

# New pattern
.agentos/
```

If multiple files are needed, provide each in a separate code block with its own `# File:` header.
