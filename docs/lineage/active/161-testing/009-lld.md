# 1161 - Fix: Unicode encoding error in subprocess calls on Windows

<!-- Template Metadata
Last Updated: 2026-02-02
Updated By: Manual LLD (workflow bootstrap fix)
Update Reason: Initial LLD - workflow cannot process its own bug report due to encoding issue
-->

## 1. Context & Goal
* **Issue:** #161
* **Objective:** Fix subprocess calls to use UTF-8 encoding so the requirements workflow can process GitHub issues containing Unicode characters on Windows
* **Status:** Draft
* **Related Issues:** RCA-PDF-extraction-pipeline #35 (blocked by this bug)

### Open Questions

- [x] ~~Which files contain affected subprocess calls?~~ *Resolved: Primarily `load_input.py`, but all subprocess calls should be fixed for consistency*
- [ ] Should we set encoding globally via environment variable or per-call?

## 2. Proposed Changes

*This section is the **source of truth** for implementation. Describes exactly what will be built.*

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `agentos/workflows/requirements/nodes/load_input.py` | Modify | Add `encoding='utf-8'` to subprocess.run call |
| `agentos/workflows/requirements/nodes/finalize.py` | Modify | Add `encoding='utf-8'` to any subprocess calls |
| `tools/run_requirements_workflow.py` | Modify | Add `encoding='utf-8'` to subprocess calls if present |
| `tests/unit/test_requirements_nodes.py` | Modify | Add test for Unicode issue handling |

### 2.2 Dependencies

*No new packages required.*

```toml
# pyproject.toml additions (if any)
# None
```

### 2.3 Data Structures

*No new data structures required. This is a parameter fix.*

### 2.4 Function Signatures

*No new functions. Existing subprocess.run calls modified.*

### 2.5 Logic Flow (Pseudocode)

```
BEFORE (broken on Windows with Unicode):
result = subprocess.run(
    ["gh", "issue", "view", str(issue_number), "--json", "title,body"],
    capture_output=True,
    text=True,
    cwd=target_repo,
    timeout=GH_TIMEOUT_SECONDS,
)

AFTER (works on all platforms):
result = subprocess.run(
    ["gh", "issue", "view", str(issue_number), "--json", "title,body"],
    capture_output=True,
    text=True,
    encoding='utf-8',  # <-- THE FIX
    cwd=target_repo,
    timeout=GH_TIMEOUT_SECONDS,
)
```

### 2.6 Technical Approach

* **Module:** `agentos/workflows/requirements/nodes/`
* **Pattern:** Parameter addition to existing calls
* **Key Decisions:**
  - Use `encoding='utf-8'` parameter rather than environment variable (more explicit, less side effects)
  - Apply to all subprocess calls that read text output for consistency
  - UTF-8 is safe on Linux/macOS (already default) and fixes Windows

### 2.7 Architecture Decisions

| Decision | Options Considered | Choice | Rationale |
|----------|-------------------|--------|-----------|
| Encoding method | `encoding='utf-8'` param, `PYTHONIOENCODING` env var, `errors='replace'` | `encoding='utf-8'` | Explicit, no global side effects, preserves data |
| Scope | Fix only load_input.py, Fix all subprocess calls | Fix all subprocess calls | Prevents similar bugs elsewhere |
| Error handling | `errors='replace'`, `errors='ignore'`, strict | strict (default) | Fail fast if truly invalid data |

**Architectural Constraints:**
- Must not break Linux/macOS behavior
- Must preserve full Unicode content (no lossy replacement)

## 3. Requirements

*What must be true when this is done.*

1. `gh issue view` output with Unicode box-drawing characters parses correctly on Windows
2. Issues containing emojis, international characters, or other Unicode parse correctly
3. Linux/macOS behavior unchanged (UTF-8 already default)
4. No data loss or character replacement in issue content

## 4. Alternatives Considered

| Option | Pros | Cons | Decision |
|--------|------|------|----------|
| `encoding='utf-8'` parameter | Explicit, targeted, no side effects | Must add to each call | **Selected** |
| `PYTHONIOENCODING` env var | One-time global fix | Affects all subprocesses, hidden behavior | Rejected |
| `errors='replace'` | Never crashes | Loses data (replaces unknown chars with ?) | Rejected |
| Read as bytes, decode manually | Full control | More code, same result | Rejected |

## 5. Data & Fixtures

### 5.1 Test Fixtures

| Fixture | Source | Notes |
|---------|--------|-------|
| `unicode_issue.json` | Generated | Mock gh output with box-drawing chars |
| `emoji_issue.json` | Generated | Mock gh output with emojis |

## 6. Diagram

*Not applicable - simple parameter fix.*

## 7. Security & Safety Considerations

### 7.1 Security

| Concern | Mitigation | Status |
|---------|------------|--------|
| Encoding injection | UTF-8 is well-defined, no injection vector | N/A |

### 7.2 Safety

| Concern | Mitigation | Status |
|---------|------------|--------|
| Data loss | Using strict encoding (no replacement) | Addressed |
| Breaking existing workflows | UTF-8 is superset, safe on all platforms | Addressed |

**Fail Mode:** If invalid UTF-8 encountered, subprocess raises exception (fail-fast).

## 8. Performance & Cost Considerations

*No performance impact. Encoding parameter is metadata only.*

## 9. Legal & Compliance

*Not applicable.*

## 10. Verification & Testing

### 10.1 Test Scenarios

| ID | Scenario | Type | Input | Expected Output | Pass Criteria |
|----|----------|------|-------|-----------------|---------------|
| 005 | Verify code passes linting | Unit | Changed files | No lint errors | flake8/ruff returns exit 0 |
| 010 | Verify encoding param on load_input subprocess | Unit | Mock subprocess.run | Called with encoding='utf-8' | Assert call includes encoding='utf-8' |
| 020 | Verify encoding param on finalize subprocess | Unit | Mock subprocess.run | Called with encoding='utf-8' | Assert call includes encoding='utf-8' |
| 030 | Parse issue with box-drawing chars | Unit | Mock JSON with Unicode | Parsed correctly | No UnicodeDecodeError, content preserved |
| 040 | Parse issue with emojis | Unit | Mock JSON with emojis | Parsed correctly | Content preserved |
| 050 | Parse ASCII-only issue (regression) | Unit | Mock JSON ASCII only | Parsed correctly | No behavior change |
| 060 | Handle malformed UTF-8 gracefully | Unit | Invalid byte sequence | Graceful error or replacement | No crash, clear error message |
| 070 | Windows CI validation | Integration | CI on Windows runner | Workflow completes | Exit code 0 |

### 10.2 Test Commands

```bash
# Run unit tests
poetry run pytest tests/unit/test_requirements_nodes.py -v -k "unicode"

# Integration test with real Unicode issue
poetry run python tools/run_requirements_workflow.py --type lld --issue 35 --gates none --repo /path/to/RCA-PDF-extraction-pipeline
```

## 11. Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaks on truly invalid UTF-8 | Low | Very Low | gh CLI outputs valid UTF-8 |
| Missed subprocess call | Medium | Low | Grep audit of all subprocess usage |

## 12. Definition of Done

### Code
- [ ] `encoding='utf-8'` added to subprocess.run in load_input.py
- [ ] Same fix applied to other subprocess calls in requirements workflow
- [ ] Code linted

### Tests
- [ ] Unit test for Unicode issue parsing
- [ ] Integration test passes on Windows

### Documentation
- [ ] LLD updated with any deviations

### Review
- [ ] Code review completed

---

## Appendix: Review Log

| Review | Date | Verdict | Key Issue |
|--------|------|---------|-----------|
| Manual creation | 2026-02-02 | DRAFT | Bootstrap fix - workflow blocked by own bug |

**Final Status:** DRAFT
