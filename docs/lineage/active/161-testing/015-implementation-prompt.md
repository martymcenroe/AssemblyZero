# Implementation Request

## Context

You are implementing code for Issue #161 using TDD.
This is iteration 0 of the implementation.

## Requirements

The tests have been scaffolded and need implementation code to pass.

### LLD Summary

# 1161 - Fix: Unicode encoding error in subprocess calls on Windows

<!-- Template Metadata
Last Updated: 2026-02-02
Updated By: Manual LLD (workflow bootstrap fix)
Update Reason: Initial LLD - workflow cannot process its own bug report due to encoding issue
-->

## 1. Context & Goal
* **Issue:** #161
* **Objective:** Fix subprocess calls to use UTF-8 encoding so the requirements workflow can process GitHub issues containing Unicode characters on Windows
* **Status:** Draft
* **Related Issues:** RCA-PDF-extraction-pipeline #35 (blocked by this bug)

### Open Questions

- [x] ~~Which files contain affected subprocess calls?~~ *Resolved: Primarily `load_input.py`, but all subprocess calls should be fixed for consistency*
- [ ] Should we set encoding globally via environment variable or per-call?

## 2. Proposed Changes

*This section is the **source of truth** for implementation. Describes exactly what will be built.*

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `agentos/workflows/requirements/nodes/load_input.py` | Modify | Add `encoding='utf-8'` to subprocess.run call |
| `agentos/workflows/requirements/nodes/finalize.py` | Modify | Add `encoding='utf-8'` to any subprocess calls |
| `tools/run_requirements_workflow.py` | Modify | Add `encoding='utf-8'` to subprocess calls if present |
| `tests/unit/test_requirements_nodes.py` | Modify | Add test for Unicode issue handling |

### 2.2 Dependencies

*No new packages required.*

```toml
# pyproject.toml additions (if any)
# None
```

### 2.3 Data Structures

*No new data structures required. This is a parameter fix.*

### 2.4 Function Signatures

*No new functions. Existing subprocess.run calls modified.*

### 2.5 Logic Flow (Pseudocode)

```
BEFORE (broken on Windows with Unicode):
result = subprocess.run(
    ["gh", "issue", "view", str(issue_number), "--json", "title,body"],
    capture_output=True,
    text=True,
    cwd=target_repo,
    timeout=GH_TIMEOUT_SECON...

### Test Scenarios

- **test_005**: Verify code passes linting | Unit | Changed files | No lint errors | flake8/ruff returns exit 0
  - Requirement: 
  - Type: unit

- **test_010**: Verify encoding param on load_input subprocess | Unit | Mock subprocess.run | Called with encoding='utf-8' | Assert call includes encoding='utf-8'
  - Requirement: 
  - Type: unit

- **test_020**: Verify encoding param on finalize subprocess | Unit | Mock subprocess.run | Called with encoding='utf-8' | Assert call includes encoding='utf-8'
  - Requirement: 
  - Type: unit

- **test_030**: Parse issue with box-drawing chars | Unit | Mock JSON with Unicode | Parsed correctly | No UnicodeDecodeError, content preserved
  - Requirement: 
  - Type: unit

- **test_040**: Parse issue with emojis | Unit | Mock JSON with emojis | Parsed correctly | Content preserved
  - Requirement: 
  - Type: unit

- **test_050**: Parse ASCII-only issue (regression) | Unit | Mock JSON ASCII only | Parsed correctly | No behavior change
  - Requirement: 
  - Type: unit

- **test_060**: Handle malformed UTF-8 gracefully | Unit | Invalid byte sequence | Graceful error or replacement | No crash, clear error message
  - Requirement: 
  - Type: unit

- **test_070**: Windows CI validation | Integration | CI on Windows runner | Workflow completes | Exit code 0
  - Requirement: 
  - Type: integration

### Test File: C:\Users\mcwiz\Projects\AgentOS-161\tests\test_issue_161.py

```python
"""Test file for Issue #161.

Generated by AgentOS TDD Testing Workflow.
Each test starts with `assert False` - implementation will make them pass.
"""

import pytest


# Fixtures for mocking
@pytest.fixture
def mock_external_service():
    """Mock external service for isolation."""
    # TODO: Implement mock
    yield None


# Integration/E2E fixtures
@pytest.fixture
def test_client():
    """Test client for API calls."""
    # TODO: Implement test client
    yield None


# Unit Tests
# -----------

def test_005():
    """
    Verify code passes linting | Unit | Changed files | No lint errors |
    flake8/ruff returns exit 0
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_005"


def test_010(mock_external_service):
    """
    Verify encoding param on load_input subprocess | Unit | Mock
    subprocess.run | Called with encoding='utf-8' | Assert call includes
    encoding='utf-8'
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_010"


def test_020(mock_external_service):
    """
    Verify encoding param on finalize subprocess | Unit | Mock
    subprocess.run | Called with encoding='utf-8' | Assert call includes
    encoding='utf-8'
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_020"


def test_030(mock_external_service):
    """
    Parse issue with box-drawing chars | Unit | Mock JSON with Unicode |
    Parsed correctly | No UnicodeDecodeError, content preserved
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_030"


def test_040(mock_external_service):
    """
    Parse issue with emojis | Unit | Mock JSON with emojis | Parsed
    correctly | Content preserved
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_040"


def test_050(mock_external_service):
    """
    Parse ASCII-only issue (regression) | Unit | Mock JSON ASCII only |
    Parsed correctly | No behavior change
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_050"


def test_060():
    """
    Handle malformed UTF-8 gracefully | Unit | Invalid byte sequence |
    Graceful error or replacement | No crash, clear error message
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_060"



# Integration Tests
# -----------------

def test_070(test_client):
    """
    Windows CI validation | Integration | CI on Windows runner | Workflow
    completes | Exit code 0
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_070"


```

## Instructions

1. Generate implementation code that makes all tests pass
2. Follow the patterns established in the codebase
3. Ensure proper error handling
4. Add type hints where appropriate
5. Keep the implementation minimal - only what's needed to pass tests

## Output Format (CRITICAL - MUST FOLLOW EXACTLY)

For EACH file you need to create or modify, provide a code block with this EXACT format:

```python
# File: path/to/implementation.py

def function_name():
    ...
```

**Rules:**
- The `# File: path/to/file` comment MUST be the FIRST line inside the code block
- Use the language-appropriate code fence (```python, ```gitignore, ```yaml, etc.)
- Path must be relative to repository root (e.g., `src/module/file.py`)
- Do NOT include "(append)" or other annotations in the path
- Provide complete file contents, not patches or diffs

**Example for .gitignore:**
```gitignore
# File: .gitignore

# Existing patterns...
*.pyc
__pycache__/

# New pattern
.agentos/
```

If multiple files are needed, provide each in a separate code block with its own `# File:` header.
