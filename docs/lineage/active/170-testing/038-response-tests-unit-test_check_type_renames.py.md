```python
"""Test file for Issue #170.

Generated by AgentOS TDD Testing Workflow.
Tests will fail with ImportError until implementation exists (TDD RED phase).
"""

import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock
import subprocess

from agentos.nodes.check_type_renames import (
    extract_removed_types,
    find_type_usages,
    format_type_rename_error,
    log_scan_summary,
    check_type_renames,
    OrphanedUsage,
    TypeRenameIssue,
)


# Fixtures for mocking
@pytest.fixture
def mock_external_service():
    """Mock external service for isolation."""
    yield None


@pytest.fixture
def sample_class_diff():
    """Sample diff with removed class."""
    return """--- a/mymodule.py
+++ b/mymodule.py
@@ -1,5 +1,5 @@
-class OldClassName:
+class NewClassName:
     def method(self):
         pass
"""


@pytest.fixture
def sample_typeddict_diff():
    """Sample diff with removed TypedDict."""
    return """--- a/types.py
+++ b/types.py
@@ -1,3 +1,3 @@
-OldType = TypedDict('OldType', {'field': str})
+NewType = TypedDict('NewType', {'field': str})
"""


@pytest.fixture
def sample_type_alias_diff():
    """Sample diff with removed type alias."""
    return """--- a/types.py
+++ b/types.py
@@ -1,3 +1,3 @@
-OldAlias = Union[str, int]
+NewAlias = Union[str, int]
"""


@pytest.fixture
def mock_git_grep_output():
    """Mock git grep output."""
    return """src/user.py:10:from mymodule import OldClassName
src/service.py:25:    def process(self, obj: OldClassName):
"""


# Unit Tests
# -----------

def test_id():
    """
    Test module imports correctly.
    """
    # Verify all exports are available
    assert extract_removed_types is not None
    assert find_type_usages is not None
    assert format_type_rename_error is not None
    assert log_scan_summary is not None
    assert check_type_renames is not None


def test_t010(sample_class_diff):
    """
    test_extract_removed_class | Extracts class name from diff | RED
    """
    # Act
    result = extract_removed_types(sample_class_diff)
    
    # Assert
    assert len(result) == 1
    assert result[0] == ("OldClassName", "mymodule.py")


def test_t020(sample_typeddict_diff):
    """
    test_extract_removed_typeddict | Extracts TypedDict from diff | RED
    """
    # Act
    result = extract_removed_types(sample_typeddict_diff)
    
    # Assert
    assert len(result) == 1
    assert result[0] == ("OldType", "types.py")


def test_t030(sample_type_alias_diff):
    """
    test_extract_removed_type_alias | Extracts type alias from diff | RED
    """
    # Act
    result = extract_removed_types(sample_type_alias_diff)
    
    # Assert
    assert len(result) == 1
    assert result[0] == ("OldAlias", "types.py")


def test_t040():
    """
    test_find_usages_in_imports | Finds orphaned import statements | RED
    """
    # Arrange
    mock_output = "src/user.py:10:from mymodule import OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], [])
        
        # Assert
        assert len(result) == 1
        assert result[0]['file_path'] == "src/user.py"
        assert result[0]['line_number'] == 10
        assert "from mymodule import OldClassName" in result[0]['line_content']


def test_t050():
    """
    test_find_usages_in_annotations | Finds orphaned type annotations | RED
    """
    # Arrange
    mock_output = "src/service.py:25:    def process(self, obj: OldClassName):\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], [])
        
        # Assert
        assert len(result) == 1
        assert result[0]['file_path'] == "src/service.py"
        assert result[0]['line_number'] == 25
        assert "OldClassName" in result[0]['line_content']


def test_t060(mock_external_service):
    """
    test_excludes_docs_directory | Does not flag docs references | RED
    """
    # Arrange
    mock_output = "docs/api.md:10:Reference to OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], ["docs/"])
        
        # Assert
        assert len(result) == 0


def test_t070():
    """
    test_excludes_lineage_directory | Does not flag lineage references | RED
    """
    # Arrange
    mock_output = "lineage/old.py:10:from mymodule import OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], ["lineage/"])
        
        # Assert
        assert len(result) == 0


def test_t080(sample_class_diff):
    """
    test_full_workflow_pass | Passes when all usages updated | RED
    """
    # Arrange
    state = {'git_diff': sample_class_diff}
    
    with patch('subprocess.run') as mock_run:
        # No usages found (returncode=1 means no matches)
        mock_run.return_value = MagicMock(
            returncode=1,
            stdout="",
            stderr=""
        )
        
        # Act
        result = check_type_renames(state)
        
        # Assert
        assert result['type_rename_check_passed'] is True
        assert result['type_rename_issues'] == []


def test_t090(sample_class_diff):
    """
    test_full_workflow_fail | Fails when orphaned usages exist | RED
    """
    # Arrange
    state = {'git_diff': sample_class_diff}
    mock_output = "src/user.py:10:from mymodule import OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = check_type_renames(state)
        
        # Assert
        assert result['type_rename_check_passed'] is False
        assert len(result['type_rename_issues']) > 0


def test_t100():
    """
    test_error_message_format | Error includes file, line, content | RED
    """
    # Arrange
    issue = TypeRenameIssue(
        old_name="OldClassName",
        definition_file="mymodule.py",
        orphaned_usages=[
            OrphanedUsage(
                file_path="src/user.py",
                line_number=10,
                line_content="from mymodule import OldClassName"
            )
        ]
    )
    
    # Act
    result = format_type_rename_error([issue])
    
    # Assert
    assert "OldClassName" in result
    assert "src/user.py:10" in result
    assert "from mymodule import OldClassName" in result
    assert "FIX:" in result


def test_t110(mock_external_service):
    """
    test_timeout_enforcement | Raises TimeoutError when timeout exceeded | RED
    """
    # Arrange
    with patch('subprocess.run') as mock_run:
        mock_run.side_effect = subprocess.TimeoutExpired(
            cmd=['git', 'grep'],
            timeout=10.0
        )
        
        # Act & Assert
        with pytest.raises(subprocess.TimeoutExpired):
            find_type_usages("OldClassName", [Path("/repo")], [], timeout=10.0)


def test_t120():
    """
    test_log_scan_summary | Logs removed type count and files scanned | RED
    """
    # Arrange
    with patch('agentos.nodes.check_type_renames.logger') as mock_logger:
        # Act
        log_scan_summary(3, 50, 2)
        
        # Assert
        mock_logger.info.assert_called_once()
        call_args = mock_logger.info.call_args[0][0]
        assert "3 removed types" in call_args
        assert "50 files scanned" in call_args
        assert "2 issues found" in call_args


def test_010(sample_class_diff):
    """
    Extract removed class | Auto | Diff with `-class Foo:` | `[("Foo", "file.py")]` | Correct extraction
    """
    # Act
    result = extract_removed_types(sample_class_diff)
    
    # Assert
    assert len(result) == 1
    assert result[0][0] == "OldClassName"
    assert result[0][1] == "mymodule.py"


def test_020(sample_typeddict_diff):
    """
    Extract TypedDict | Auto | Diff with `-Bar = TypedDict` | `[("Bar", "file.py")]` | Correct extraction
    """
    # Act
    result = extract_removed_types(sample_typeddict_diff)
    
    # Assert
    assert len(result) == 1
    assert result[0][0] == "OldType"
    assert result[0][1] == "types.py"


def test_030(sample_type_alias_diff):
    """
    Extract type alias | Auto | Diff with `-MyType = Union[...]` | `[("MyType", "file.py")]` | Correct extraction
    """
    # Act
    result = extract_removed_types(sample_type_alias_diff)
    
    # Assert
    assert len(result) == 1
    assert result[0][0] == "OldAlias"
    assert result[0][1] == "types.py"


def test_040():
    """
    Find import usages | Auto | Codebase with `from x import Foo` | Usage detected | Found with location
    """
    # Arrange
    mock_output = "src/user.py:10:from mymodule import OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], [])
        
        # Assert
        assert len(result) == 1
        assert result[0]['file_path'] == "src/user.py"


def test_050():
    """
    Find annotation usages | Auto | Codebase with `def f(x: Foo)` | Usage detected | Found with location
    """
    # Arrange
    mock_output = "src/service.py:25:    def process(self, obj: OldClassName):\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], [])
        
        # Assert
        assert len(result) == 1
        assert result[0]['line_number'] == 25


def test_060(mock_external_service):
    """
    Exclude docs | Auto | Usage in `docs/api.md` | Not reported | No false positive
    """
    # Arrange
    mock_output = "docs/api.md:10:Reference to OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], ["docs/"])
        
        # Assert
        assert len(result) == 0


def test_070():
    """
    Exclude lineage | Auto | Usage in `lineage/old.py` | Not reported | No false positive
    """
    # Arrange
    mock_output = "lineage/old.py:10:from mymodule import OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = find_type_usages("OldClassName", [Path("/repo")], ["lineage/"])
        
        # Assert
        assert len(result) == 0


def test_080(sample_class_diff):
    """
    Clean rename passes | Auto | All usages updated | `passed=True` | Workflow continues
    """
    # Arrange
    state = {'git_diff': sample_class_diff}
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=1,
            stdout="",
            stderr=""
        )
        
        # Act
        result = check_type_renames(state)
        
        # Assert
        assert result['type_rename_check_passed'] is True


def test_090(sample_class_diff):
    """
    Orphaned usage fails | Auto | Missed usage exists | `passed=False` | Workflow stops
    """
    # Arrange
    state = {'git_diff': sample_class_diff}
    mock_output = "src/user.py:10:from mymodule import OldClassName\n"
    
    with patch('subprocess.run') as mock_run:
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout=mock_output,
            stderr=""
        )
        
        # Act
        result = check_type_renames(state)
        
        # Assert
        assert result['type_rename_check_passed'] is False


def test_100():
    """
    Error message quality | Auto | One orphaned usage | Message has file:line | Actionable output
    """
    # Arrange
    issue = TypeRenameIssue(
        old_name="OldClassName",
        definition_file="mymodule.py",
        orphaned_usages=[
            OrphanedUsage(
                file_path="src/user.py",
                line_number=10,
                line_content="from mymodule import OldClassName"
            )
        ]
    )
    
    # Act
    result = format_type_rename_error([issue])
    
    # Assert
    assert "src/user.py:10" in result


def test_110(mock_external_service):
    """
    Timeout enforcement | Auto | Mock slow grep (>10s) | TimeoutError raised | Fail-safe works
    """
    # Arrange
    with patch('subprocess.run') as mock_run:
        mock_run.side_effect = subprocess.TimeoutExpired(
            cmd=['git', 'grep'],
            timeout=10.0
        )
        
        # Act & Assert
        with pytest.raises(subprocess.TimeoutExpired):
            find_type_usages("OldClassName", [Path("/repo")], [], timeout=10.0)


def test_120():
    """
    Observability logging | Auto | Normal execution | Log contains counts | Debugging enabled
    """
    # Arrange
    with patch('agentos.nodes.check_type_renames.logger') as mock_logger:
        # Act
        log_scan_summary(3, 50, 2)
        
        # Assert
        mock_logger.info.assert_called_once()
```
