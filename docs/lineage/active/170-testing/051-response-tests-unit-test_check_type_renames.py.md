```python
"""Test file for Issue #170.

Generated by AgentOS TDD Testing Workflow.
Tests will fail with ImportError until implementation exists (TDD RED phase).
"""

import subprocess
import tempfile
from pathlib import Path
from unittest.mock import MagicMock, patch

import pytest

from agentos.nodes.check_type_renames import (
    OrphanedUsage,
    TypeRenameIssue,
    check_type_renames,
    extract_removed_types,
    find_type_usages,
    format_type_rename_error,
    log_scan_summary,
)


# Fixtures
@pytest.fixture
def sample_class_removal_diff():
    """Diff showing a class removal."""
    return """--- a/src/models.py
+++ b/src/models.py
@@ -1,10 +1,5 @@
 from typing import TypedDict
 
-class OldClassName:
-    def __init__(self):
-        pass
-
 class NewClassName:
     def __init__(self):
         pass
"""


@pytest.fixture
def sample_typeddict_removal_diff():
    """Diff showing a TypedDict removal."""
    return """--- a/src/types.py
+++ b/src/types.py
@@ -1,8 +1,3 @@
 from typing import TypedDict
 
-OldTypeName = TypedDict('OldTypeName', {
-    'field1': str,
-    'field2': int,
-})
-
 NewTypeName = TypedDict('NewTypeName', {
"""


@pytest.fixture
def sample_type_alias_removal_diff():
    """Diff showing a type alias removal."""
    return """--- a/src/types.py
+++ b/src/types.py
@@ -1,5 +1,2 @@
 from typing import Union, Optional
 
-MyOldType = Union[str, int]
-
 MyNewType = Optional[str]
"""


@pytest.fixture
def temp_git_repo(tmp_path):
    """Create a temporary git repository for testing."""
    repo_dir = tmp_path / "test_repo"
    repo_dir.mkdir()
    
    # Initialize git repo
    subprocess.run(['git', 'init'], cwd=str(repo_dir), check=True, capture_output=True)
    subprocess.run(['git', 'config', 'user.email', 'test@example.com'], cwd=str(repo_dir), check=True, capture_output=True)
    subprocess.run(['git', 'config', 'user.name', 'Test User'], cwd=str(repo_dir), check=True, capture_output=True)
    
    return repo_dir


# Unit Tests
def test_id():
    """Verify module imports work correctly."""
    assert check_type_renames is not None
    assert extract_removed_types is not None
    assert find_type_usages is not None


def test_t010(sample_class_removal_diff):
    """test_extract_removed_class | Extracts class name from diff | RED"""
    removed_types = extract_removed_types(sample_class_removal_diff)
    
    assert len(removed_types) == 1
    assert removed_types[0] == ('OldClassName', 'src/models.py')


def test_t020(sample_typeddict_removal_diff):
    """test_extract_removed_typeddict | Extracts TypedDict from diff | RED"""
    removed_types = extract_removed_types(sample_typeddict_removal_diff)
    
    assert len(removed_types) == 1
    assert removed_types[0] == ('OldTypeName', 'src/types.py')


def test_t030(sample_type_alias_removal_diff):
    """test_extract_removed_type_alias | Extracts type alias from diff | RED"""
    removed_types = extract_removed_types(sample_type_alias_removal_diff)
    
    assert len(removed_types) == 1
    assert removed_types[0] == ('MyOldType', 'src/types.py')


def test_t040(temp_git_repo):
    """test_find_usages_in_imports | Finds orphaned import statements | RED"""
    # Create a file with an import
    test_file = temp_git_repo / "module.py"
    test_file.write_text("from models import OldClassName\n")
    
    # Add and commit
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Initial'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('OldClassName', [temp_git_repo], [])
    
    assert len(usages) == 1
    assert usages[0]['file_path'] == 'module.py'
    assert 'OldClassName' in usages[0]['line_content']


def test_t050(temp_git_repo):
    """test_find_usages_in_annotations | Finds orphaned type annotations | RED"""
    # Create a file with type annotation
    test_file = temp_git_repo / "module.py"
    test_file.write_text("def process(item: OldClassName) -> None:\n    pass\n")
    
    # Add and commit
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Initial'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('OldClassName', [temp_git_repo], [])
    
    assert len(usages) == 1
    assert 'OldClassName' in usages[0]['line_content']


def test_t060(temp_git_repo):
    """test_excludes_docs_directory | Does not flag docs references | RED"""
    # Create docs directory with reference
    docs_dir = temp_git_repo / "docs"
    docs_dir.mkdir()
    docs_file = docs_dir / "api.py"
    docs_file.write_text("# Example: OldClassName usage\n")
    
    # Add and commit
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Initial'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('OldClassName', [temp_git_repo], ['docs/'])
    
    assert len(usages) == 0


def test_t070(temp_git_repo):
    """test_excludes_lineage_directory | Does not flag lineage references | RED"""
    # Create lineage directory with reference
    lineage_dir = temp_git_repo / "lineage"
    lineage_dir.mkdir()
    lineage_file = lineage_dir / "old.py"
    lineage_file.write_text("# Old usage: OldClassName\n")
    
    # Add and commit
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Initial'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('OldClassName', [temp_git_repo], ['lineage/'])
    
    assert len(usages) == 0


def test_t080(sample_class_removal_diff, temp_git_repo):
    """test_full_workflow_pass | Passes when all usages updated | RED"""
    # Create initial file with class
    models_file = temp_git_repo / "models.py"
    models_file.write_text("class OldClassName:\n    pass\n")
    
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Initial'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    # No orphaned usages (class was removed, no other references)
    state = {
        'diff': sample_class_removal_diff,
        'repo_root': str(temp_git_repo),
    }
    
    result = check_type_renames(state)
    
    assert result['type_rename_check_passed'] is True
    assert len(result['type_rename_issues']) == 0


def test_t090(sample_class_removal_diff, temp_git_repo):
    """test_full_workflow_fail | Fails when orphaned usages exist | RED"""
    # Create file with usage
    usage_file = temp_git_repo / "usage.py"
    usage_file.write_text("from models import OldClassName\n")
    
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Initial'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    state = {
        'diff': sample_class_removal_diff,
        'repo_root': str(temp_git_repo),
    }
    
    result = check_type_renames(state)
    
    assert result['type_rename_check_passed'] is False
    assert len(result['type_rename_issues']) > 0


def test_t100():
    """test_error_message_format | Error includes file, line, content | RED"""
    issues = [
        TypeRenameIssue(
            old_name='OldClass',
            definition_file='models.py',
            orphaned_usages=[
                OrphanedUsage(
                    file_path='usage.py',
                    line_number=5,
                    line_content='from models import OldClass',
                )
            ],
        )
    ]
    
    error_msg = format_type_rename_error(issues)
    
    assert 'OldClass' in error_msg
    assert 'usage.py:5' in error_msg
    assert 'from models import OldClass' in error_msg


def test_t110(temp_git_repo):
    """test_timeout_enforcement | Raises TimeoutError when timeout exceeded | RED"""
    # Mock subprocess.run to simulate timeout
    with patch('agentos.nodes.check_type_renames.subprocess.run') as mock_run:
        mock_run.side_effect = subprocess.TimeoutExpired('git', 0.1)
        
        with pytest.raises(TimeoutError):
            find_type_usages('SomeType', [temp_git_repo], [], timeout=0.1)


def test_t120(caplog):
    """test_log_scan_summary | Logs removed type count and files scanned | RED"""
    import logging
    caplog.set_level(logging.INFO)
    
    log_scan_summary(removed_types_count=3, files_scanned=10, issues_found=1)
    
    assert 'detected 3 removed types' in caplog.text
    assert 'scanned 10 files' in caplog.text
    assert 'found 1 orphaned usage issues' in caplog.text


def test_010(sample_class_removal_diff):
    """Extract removed class | Auto | Diff with `-class Foo:` | `[("Foo", "file.py")]` | Correct extraction"""
    removed_types = extract_removed_types(sample_class_removal_diff)
    
    assert ('OldClassName', 'src/models.py') in removed_types


def test_020(sample_typeddict_removal_diff):
    """Extract TypedDict | Auto | Diff with `-Bar = TypedDict` | `[("Bar", "file.py")]` | Correct extraction"""
    removed_types = extract_removed_types(sample_typeddict_removal_diff)
    
    assert ('OldTypeName', 'src/types.py') in removed_types


def test_030(sample_type_alias_removal_diff):
    """Extract type alias | Auto | Diff with `-MyType = Union[...]` | `[("MyType", "file.py")]` | Correct extraction"""
    removed_types = extract_removed_types(sample_type_alias_removal_diff)
    
    assert ('MyOldType', 'src/types.py') in removed_types


def test_040(temp_git_repo):
    """Find import usages | Auto | Codebase with `from x import Foo` | Usage detected | Found with location"""
    test_file = temp_git_repo / "test.py"
    test_file.write_text("from x import Foo\n")
    
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Test'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('Foo', [temp_git_repo], [])
    
    assert len(usages) > 0
    assert any('Foo' in u['line_content'] for u in usages)


def test_050(temp_git_repo):
    """Find annotation usages | Auto | Codebase with `def f(x: Foo)` | Usage detected | Found with location"""
    test_file = temp_git_repo / "test.py"
    test_file.write_text("def f(x: Foo) -> None:\n    pass\n")
    
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Test'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('Foo', [temp_git_repo], [])
    
    assert len(usages) > 0
    assert any('Foo' in u['line_content'] for u in usages)


def test_060(temp_git_repo):
    """Exclude docs | Auto | Usage in `docs/api.md` | Not reported | No false positive"""
    docs_dir = temp_git_repo / "docs"
    docs_dir.mkdir()
    docs_file = docs_dir / "api.py"
    docs_file.write_text("Reference to Foo class\n")
    
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Test'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('Foo', [temp_git_repo], ['docs/'])
    
    assert len(usages) == 0


def test_070(temp_git_repo):
    """Exclude lineage | Auto | Usage in `lineage/old.py` | Not reported | No false positive"""
    lineage_dir = temp_git_repo / "lineage"
    lineage_dir.mkdir()
    lineage_file = lineage_dir / "old.py"
    lineage_file.write_text("Old Foo usage\n")
    
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Test'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    usages = find_type_usages('Foo', [temp_git_repo], ['lineage/'])
    
    assert len(usages) == 0


def test_080(temp_git_repo):
    """Clean rename passes | Auto | All usages updated | `passed=True` | Workflow continues"""
    diff = """--- a/models.py
+++ b/models.py
@@ -1,3 +1,3 @@
-class OldName:
+class NewName:
     pass
"""
    
    state = {
        'diff': diff,
        'repo_root': str(temp_git_repo),
    }
    
    result = check_type_renames(state)
    
    assert result['type_rename_check_passed'] is True


def test_090(temp_git_repo):
    """Orphaned usage fails | Auto | Missed usage exists | `passed=False` | Workflow stops"""
    # Create usage
    usage_file = temp_git_repo / "usage.py"
    usage_file.write_text("x = OldName()\n")
    
    subprocess.run(['git', 'add', '.'], cwd=str(temp_git_repo), check=True, capture_output=True)
    subprocess.run(['git', 'commit', '-m', 'Test'], cwd=str(temp_git_repo), check=True, capture_output=True)
    
    diff = """--- a/models.py
+++ b/models.py
@@ -1,3 +0,0 @@
-class OldName:
-    pass
"""
    
    state = {
        'diff': diff,
        'repo_root': str(temp_git_repo),
    }
    
    result = check_type_renames(state)
    
    assert result['type_rename_check_passed'] is False


def test_100():
    """Error message quality | Auto | One orphaned usage | Message has file:line | Actionable output"""
    issues = [
        TypeRenameIssue(
            old_name='TestClass',
            definition_file='src/models.py',
            orphaned_usages=[
                OrphanedUsage(
                    file_path='src/usage.py',
                    line_number=10,
                    line_content='obj = TestClass()',
                )
            ],
        )
    ]
    
    error_msg = format_type_rename_error(issues)
    
    assert 'src/usage.py:10' in error_msg
    assert 'obj = TestClass()' in error_msg


def test_110(temp_git_repo):
    """Timeout enforcement | Auto | Mock slow grep (>10s) | TimeoutError raised | Fail-safe works"""
    with patch('agentos.nodes.check_type_renames.subprocess.run') as mock_run:
        mock_run.side_effect = subprocess.TimeoutExpired('git grep', 10.0)
        
        with pytest.raises(TimeoutError) as exc_info:
            find_type_usages('TestType', [temp_git_repo], [], timeout=10.0)
        
        assert 'exceeded' in str(exc_info.value)


def test_120(caplog):
    """Observability logging | Auto | Normal execution | Log contains counts | Debugging enabled"""
    import logging
    caplog.set_level(logging.INFO)
    
    log_scan_summary(removed_types_count=5, files_scanned=20, issues_found=2)
    
    assert '5 removed types' in caplog.text
    assert '20 files' in caplog.text
    assert '2 orphaned usage issues' in caplog.text
```
