# Implementation Request

## Context

You are implementing code for Issue #106 using TDD.
This is iteration 0 of the implementation.

## Requirements

The tests have been scaffolded and need implementation code to pass.

### LLD Summary

# 1106 - Feature: Parallel Workflow Execution for LLD and Issue Processing

<!-- Template Metadata
Last Updated: 2026-02-02
Updated By: Issue #117 fix
Update Reason: Moved Verification & Testing to Section 10 (was Section 11) to match 0702c review prompt and testing workflow expectations
Previous: Added sections based on 80 blocking issues from 164 governance verdicts (2026-02-01)
-->

## 1. Context & Goal
* **Issue:** #106
* **Objective:** Enable concurrent execution of LLD and Issue workflows with the `--all` flag, solving SQLite contention, credential pool management, and output coordination challenges to dramatically reduce batch operation time.
* **Status:** Draft
* **Related Issues:** N/A

### Open Questions
*Questions that need clarification before or during implementation. Remove when resolved.*

- [ ] Should rate-limited keys be automatically retried after backoff, or should manual intervention be required?
- [ ] What is the maximum acceptable coordination overhead percentage for parallel execution?

## 2. Proposed Changes

*This section is the **source of truth** for implementation. Describe exactly what will be built.*

### 2.1 Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| `agentos/workflows/parallel/__init__.py` | Add | Module exports for parallel workflow components |
| `agentos/workflows/parallel/coordinator.py` | Add | New coordinator managing worker pool, progress tracking, and graceful shutdown |
| `agentos/workflows/parallel/credential_coordinator.py` | Add | Thread-safe credential reservation system with rate-limit tracking |
| `agentos/workflows/parallel/output_prefixer.py` | Add | Stdout/stderr wrapper with prefix injection for workflow identification |
| `agentos/workflows/parallel/input_sanitizer.py` | Add | Input validation utilities for path-safe identifiers |
| `agentos/workflows/lld/workflow.py` | Modify | Add `--parallel` and `--dry-run` flags, integrate with coordinator |
| `agentos/workflows/...

### Test Scenarios

- **test_010**: Happy path: 3 LLDs processed in parallel | Auto | 3 mock LLDs, --parallel 3 | All complete, progress report shows 3/3 | Exit code 0, all DBs cleaned up
  - Requirement: 
  - Type: unit

- **test_020**: Dry run lists without executing | Auto | 5 pending items, --dry-run | List of 5 items printed | No subprocess spawned, no DBs created
  - Requirement: 
  - Type: unit

- **test_030**: Path traversal rejected | Auto | Issue number "../etc/passwd" | ValueError raised | Clear error message, no file access
  - Requirement: 
  - Type: unit

- **test_040**: Credential exhaustion pauses workers | Auto | 5 items, 2 credentials, --parallel 5 | Workers pause, resume on release | Log shows "[COORDINATOR] Credential pool exhausted"
  - Requirement: 
  - Type: unit

- **test_050**: HTTP 429 triggers backoff | Auto | AGENTOS_SIMULATE_429=true | Key marked rate-limited | Backoff applied, different key used or wait
  - Requirement: 
  - Type: unit

- **test_060**: Single workflow failure isolated | Auto | 1 invalid spec among 3 | 2 succeed, 1 fails | Failed item in report, others complete
  - Requirement: 
  - Type: unit

- **test_070**: Graceful shutdown on SIGINT | Auto | SIGINT during execution | Workers checkpoint and exit | All checkpoint DBs written within 5s
  - Requirement: 
  - Type: unit

- **test_080**: Output prefix prevents interleaving | Auto | 3 parallel workflows | All lines prefixed correctly | No partial line mixing
  - Requirement: 
  - Type: unit

- **test_090**: Performance benchmark | Auto-Live | 6 items, sequential vs --parallel 3 | Parallel < 50% sequential time | Timing comparison logged
  - Requirement: 
  - Type: unit

- **test_100**: Max parallelism enforced | Auto | Capped to 10 | Warning logged, runs with 10
  - Requirement: 
  - Type: unit

- **test_110**: Default parallelism applied | Auto | Uses 3 | Config shows max_parallelism=3
  - Requirement: 
  - Type: unit

### Test File: C:\Users\mcwiz\Projects\AgentOS-106\tests\test_issue_106.py

```python
"""Test file for Issue #106.

Generated by AgentOS TDD Testing Workflow.
Each test starts with `assert False` - implementation will make them pass.
"""

import pytest


# Fixtures for mocking
@pytest.fixture
def mock_external_service():
    """Mock external service for isolation."""
    # TODO: Implement mock
    yield None


# Unit Tests
# -----------

def test_010(mock_external_service):
    """
    Happy path: 3 LLDs processed in parallel | Auto | 3 mock LLDs,
    --parallel 3 | All complete, progress report shows 3/3 | Exit code 0,
    all DBs cleaned up
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_010"


def test_020():
    """
    Dry run lists without executing | Auto | 5 pending items, --dry-run |
    List of 5 items printed | No subprocess spawned, no DBs created
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_020"


def test_030():
    """
    Path traversal rejected | Auto | Issue number "../etc/passwd" |
    ValueError raised | Clear error message, no file access
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_030"


def test_040():
    """
    Credential exhaustion pauses workers | Auto | 5 items, 2 credentials,
    --parallel 5 | Workers pause, resume on release | Log shows
    "[COORDINATOR] Credential pool exhausted"
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_040"


def test_050():
    """
    HTTP 429 triggers backoff | Auto | AGENTOS_SIMULATE_429=true | Key
    marked rate-limited | Backoff applied, different key used or wait
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_050"


def test_060():
    """
    Single workflow failure isolated | Auto | 1 invalid spec among 3 | 2
    succeed, 1 fails | Failed item in report, others complete
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_060"


def test_070():
    """
    Graceful shutdown on SIGINT | Auto | SIGINT during execution |
    Workers checkpoint and exit | All checkpoint DBs written within 5s
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_070"


def test_080():
    """
    Output prefix prevents interleaving | Auto | 3 parallel workflows |
    All lines prefixed correctly | No partial line mixing
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_080"


def test_090():
    """
    Performance benchmark | Auto-Live | 6 items, sequential vs --parallel
    3 | Parallel < 50% sequential time | Timing comparison logged
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_090"


def test_100():
    """
    Max parallelism enforced | Auto | Capped to 10 | Warning logged, runs
    with 10
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_100"


def test_110():
    """
    Default parallelism applied | Auto | Uses 3 | Config shows
    max_parallelism=3
    """
    # TDD: Arrange
    # TODO: Set up test data and mocks

    # TDD: Act
    # TODO: Call the function/method under test

    # TDD: Assert
    assert False, "TDD: Implementation pending for test_110"


```

## Instructions

1. Generate implementation code that makes all tests pass
2. Follow the patterns established in the codebase
3. Ensure proper error handling
4. Add type hints where appropriate
5. Keep the implementation minimal - only what's needed to pass tests

## Output Format (CRITICAL - MUST FOLLOW EXACTLY)

For EACH file you need to create or modify, provide a code block with this EXACT format:

```python
# File: path/to/implementation.py

def function_name():
    ...
```

**Rules:**
- The `# File: path/to/file` comment MUST be the FIRST line inside the code block
- Use the language-appropriate code fence (```python, ```gitignore, ```yaml, etc.)
- Path must be relative to repository root (e.g., `src/module/file.py`)
- Do NOT include "(append)" or other annotations in the path
- Provide complete file contents, not patches or diffs

**Example for .gitignore:**
```gitignore
# File: .gitignore

# Existing patterns...
*.pyc
__pycache__/

# New pattern
.agentos/
```

If multiple files are needed, provide each in a separate code block with its own `# File:` header.
