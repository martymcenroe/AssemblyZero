# 0905 - Runbook: Gemini Credentials Management

## Purpose

Manage and test Gemini API credentials for the rotation system. Supports multiple API keys across different Google accounts plus OAuth authentication.

## Credential Types

| Type | Description | Quota |
|------|-------------|-------|
| OAuth | Uses Google account login via `~/.gemini/oauth_creds.json` | Tied to Google Cloud project |
| API Key | Generated from AI Studio, stored in credentials file | Free tier or trial credits |

## Files

| File | Purpose |
|------|---------|
| `~/.assemblyzero/gemini-credentials.json` | Credential configuration (keys, enabled state) |
| `~/.assemblyzero/gemini-rotation-state.json` | Runtime state (quota exhaustion tracking) |
| `~/.assemblyzero/gemini-api.jsonl` | API event log (quota exhaustion, rotation, errors) |
| `~/.gemini/oauth_creds.json` | OAuth token (auto-generated by gemini CLI) |

## Testing All Credentials

Run the test script to verify all credentials (including disabled ones):

```bash
poetry run --directory /c/Users/mcwiz/Projects/AssemblyZero python /c/Users/mcwiz/Projects/AssemblyZero/tools/gemini-test-credentials.py
```

**Expected output:**
```
============================================================
GEMINI CREDENTIAL TEST
Testing with model: gemini-2.0-flash
Prompt: "Say hello in exactly 3 words."
============================================================

Testing: oauth-primary [oauth] [ENABLED]
--------------------------------------------------
  PASS OK - Response: Hello to you.

Testing: api-key-1 (account@example.com) [api_key] [ENABLED]
--------------------------------------------------
  PASS OK - Response: Hello to you.

...

============================================================
SUMMARY
============================================================
Total credentials: N
Working: N
Working + Enabled: N
```

## Adding a New API Key

1. Go to https://aistudio.google.com/
2. Sign in with a Google account
3. Click **Get API Key** â†’ **Create API key**
4. Copy the key (looks like `AIzaSy...`)
5. Edit the credentials file:

```bash
notepad ~/.assemblyzero/gemini-credentials.json
# or
code ~/.assemblyzero/gemini-credentials.json
```

6. Add a new entry to the `credentials` array:

```json
{
  "name": "api-key-N",
  "account-name": "your-account@gmail.com",
  "type": "api_key",
  "key": "AIzaSy...",
  "enabled": true,
  "notes": "Description of this key"
}
```

7. Save the file
8. Run the test script to verify

## Disabling a Credential

Edit `~/.assemblyzero/gemini-credentials.json` and set `"enabled": false` for the credential.

Reasons to disable:
- Quota exhausted (will auto-recover via rotation state)
- Key revoked or deleted
- Account closed or billing expired

## Common Error Codes

| Error | Meaning | Action |
|-------|---------|--------|
| 401 | Authentication failed | Check API key is valid |
| 403 | Permission denied | Check API key permissions in Google Cloud |
| 429 | Rate limited | Wait or rotate to next credential |
| 529 | Gemini overloaded | Wait and retry (Monday mornings common) |
| QUOTA_EXHAUSTED | Daily/monthly quota hit | Rotation system handles this |
| API_KEY_INVALID | Key deleted or malformed | Get new key from AI Studio |

## Restricting API Keys (Security)

For security, restrict keys to only the Generative Language API:

1. Go to https://console.cloud.google.com/apis/credentials
2. Click on your API key
3. Under **API restrictions**, select **Restrict key**
4. Check only **Generative Language API**
5. Click **Save**

## Rotation System

The `gemini-rotate.py` tool automatically:
- Tries credentials in order until one succeeds
- Marks exhausted credentials with reset time
- Rotates to next credential on quota errors
- Provides human-readable error messages identifying which account failed

**Usage:**
```bash
poetry run --directory /c/Users/mcwiz/Projects/AssemblyZero python /c/Users/mcwiz/Projects/AssemblyZero/tools/gemini-rotate.py --prompt "Hello"
poetry run --directory /c/Users/mcwiz/Projects/AssemblyZero python /c/Users/mcwiz/Projects/AssemblyZero/tools/gemini-rotate.py --status
```

## Monitoring Credential Health

### API Event Log

The file `~/.assemblyzero/gemini-api.jsonl` tracks all Gemini API events. Each line is a JSON object:

```json
{"timestamp": "2026-01-31T20:49:18+00:00", "event": "quota_exhausted", "credential": "oauth-primary", "model": "gemini-3-pro-preview", "reset_time": "2026-02-01T20:49:18+00:00", "error": "429 quota exhausted, will reset in 24h"}
```

**Event types:**

| Event | Description | Action |
|-------|-------------|--------|
| `quota_exhausted` | 429 error - daily quota hit | Check `reset_time` for when it refreshes |
| `capacity_exhausted` | 529 error - temporary overload | System auto-retries with backoff |
| `credential_rotated` | Switched to next credential | Normal behavior |
| `auth_error` | Invalid key or permission denied | Check/replace the credential |
| `api_error` | Other API error | Investigate error message |
| `all_exhausted` | All credentials already exhausted | Add more API keys |
| `all_credentials_failed` | All credentials tried, all failed | Check log for specific errors |

### Quick Status Check

View recent events:
```bash
tail -20 ~/.assemblyzero/gemini-api.jsonl
```

Count quota exhaustions today:
```bash
grep "quota_exhausted" ~/.assemblyzero/gemini-api.jsonl | grep "$(date +%Y-%m-%d)" | wc -l
```

See which credentials are exhausted:
```bash
grep "quota_exhausted" ~/.assemblyzero/gemini-api.jsonl | tail -5
```

### Programmatic Status

```python
from assemblyzero.core.gemini_client import get_credential_status
status = get_credential_status()
print(f"Available: {status['available']}/{status['total']}")
print(f"Exhausted: {status['exhausted']}")
```

### When to Add More API Keys

Add more keys when you frequently see:
- `all_exhausted` events
- `all_credentials_failed` events
- Multiple `quota_exhausted` events in a single day

Google gives 90 days free when you sign up with a new Gmail account. Each account can have multiple API keys.

## Troubleshooting

### "Unknown error" messages
The rotation script now identifies which account failed. If you see generic errors, update to latest version.

### All credentials failing
1. Run test script to identify which are broken
2. Check https://status.cloud.google.com for Gemini outages
3. Monday mornings often see 529 errors due to load

### OAuth not working
```bash
rm ~/.gemini/oauth_creds.json
gemini --prompt "test"
# Follow browser auth flow
```

### API key works in test but not rotation
Check that `enabled: true` in the credentials file.

## Related Documents

- `tools/gemini-rotate.py` - Rotation wrapper for gemini CLI
- `tools/gemini-test-credentials.py` - Credential test script
- `docs/runbooks/0900-runbook-index.md` - Index of all runbooks

## History

| Date | Change |
|------|--------|
| 2026-01-20 | Initial runbook created |
| 2026-01-20 | Added test script, improved error messages |
| 2026-01-31 | Added API event log documentation (gemini-api.jsonl) |
